From f37bcd1a45c0197b473957a19bb552a2b556bfc0 Mon Sep 17 00:00:00 2001
From: paphonb <paphonb@gmail.com>
Date: Wed, 26 Sep 2018 23:23:28 +0700
Subject: [PATCH 2/6] Lower brightness for AOD

---
 .../doze/DozeBrightnessHostForwarder.smali    | 22 ++++-
 .../android/systemui/doze/DozeFactory.smali   |  2 +
 .../systemui/doze/DozeScreenBrightness.smali  | 80 ++++++++++++-------
 .../phone/StatusBar$DozeServiceHost.smali     | 27 ++++++-
 4 files changed, 101 insertions(+), 30 deletions(-)

diff --git a/OPSystemUI/smali/com/android/systemui/doze/DozeBrightnessHostForwarder.smali b/OPSystemUI/smali/com/android/systemui/doze/DozeBrightnessHostForwarder.smali
index 39b68f0..4a6a13b 100644
--- a/OPSystemUI/smali/com/android/systemui/doze/DozeBrightnessHostForwarder.smali
+++ b/OPSystemUI/smali/com/android/systemui/doze/DozeBrightnessHostForwarder.smali
@@ -26,9 +26,29 @@
 
 # virtual methods
 .method public setDozeScreenBrightness(I)V
-    .locals 1
+    .locals 3
     .param p1, "brightness"    # I
 
+    const-string v1, "Brightness: "
+
+    new-instance v2, Ljava/lang/StringBuilder;
+
+    invoke-direct {v2}, Ljava/lang/StringBuilder;-><init>()V
+
+    invoke-virtual {v2, v1}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    invoke-virtual {v2, p1}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
+
+    invoke-virtual {v2}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+
+    move-result-object v2
+
+    const-string v1, "DozeScreenBrightness"
+
+    invoke-static {v1, v2}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I
+
+    # const p1, 0x1
+
     .line 33
     invoke-super {p0, p1}, Lcom/android/systemui/doze/DozeMachine$Service$Delegate;->setDozeScreenBrightness(I)V
 
diff --git a/OPSystemUI/smali/com/android/systemui/doze/DozeFactory.smali b/OPSystemUI/smali/com/android/systemui/doze/DozeFactory.smali
index ffd8e77..decd097 100644
--- a/OPSystemUI/smali/com/android/systemui/doze/DozeFactory.smali
+++ b/OPSystemUI/smali/com/android/systemui/doze/DozeFactory.smali
@@ -38,6 +38,8 @@
     .line 81
     move-object v10, p3
 
+    const-string v0, "android.sensor.light"
+
     invoke-static {v10, v0}, Lcom/android/systemui/doze/DozeSensors;->findSensorWithType(Landroid/hardware/SensorManager;Ljava/lang/String;)Landroid/hardware/Sensor;
 
     move-result-object v0
diff --git a/OPSystemUI/smali/com/android/systemui/doze/DozeScreenBrightness.smali b/OPSystemUI/smali/com/android/systemui/doze/DozeScreenBrightness.smali
index 0b3a973..43dc16d 100644
--- a/OPSystemUI/smali/com/android/systemui/doze/DozeScreenBrightness.smali
+++ b/OPSystemUI/smali/com/android/systemui/doze/DozeScreenBrightness.smali
@@ -145,31 +145,49 @@
     .locals 1
     .param p1, "sensorValue"    # I
 
-    .line 142
-    if-ltz p1, :cond_1
-
-    iget-object v0, p0, Lcom/android/systemui/doze/DozeScreenBrightness;->mSensorToBrightness:[I
-
-    array-length v0, v0
-
-    if-lt p1, v0, :cond_0
-
-    goto :goto_0
-
-    .line 145
-    :cond_0
-    iget-object v0, p0, Lcom/android/systemui/doze/DozeScreenBrightness;->mSensorToBrightness:[I
-
-    aget v0, v0, p1
-
-    return v0
-
-    .line 143
-    :cond_1
-    :goto_0
-    const/4 v0, -0x1
-
-    return v0
+    const v0, 0x4
+
+    div-int/2addr p1, v0
+
+    const v0, 0x20
+
+    invoke-static {v0, p1}, Ljava/lang/Math;->min(II)I
+
+    move-result p1
+
+    const/4 v0, 0x1
+
+    invoke-static {v0, p1}, Ljava/lang/Math;->max(II)I
+
+    move-result p1
+
+    return p1
+
+    # .line 142
+    # if-ltz p1, :cond_1
+    #
+    # iget-object v0, p0, Lcom/android/systemui/doze/DozeScreenBrightness;->mSensorToBrightness:[I
+    #
+    # array-length v0, v0
+    #
+    # if-lt p1, v0, :cond_0
+    #
+    # goto :goto_0
+    #
+    # .line 145
+    # :cond_0
+    # iget-object v0, p0, Lcom/android/systemui/doze/DozeScreenBrightness;->mSensorToBrightness:[I
+    #
+    # aget v0, v0, p1
+    #
+    # return v0
+    #
+    # .line 143
+    # :cond_1
+    # :goto_0
+    # const/4 v0, -0x1
+    #
+    # return v0
 .end method
 
 .method private computeScrimOpacity(I)I
@@ -211,7 +229,7 @@
 
     iget v1, p0, Lcom/android/systemui/doze/DozeScreenBrightness;->mDefaultDozeBrightness:I
 
-    invoke-interface {v0, v1}, Lcom/android/systemui/doze/DozeMachine$Service;->setDozeScreenBrightness(I)V
+    # invoke-interface {v0, v1}, Lcom/android/systemui/doze/DozeMachine$Service;->setDozeScreenBrightness(I)V
 
     .line 154
     iget-object v0, p0, Lcom/android/systemui/doze/DozeScreenBrightness;->mDozeHost:Lcom/android/systemui/doze/DozeHost;
@@ -406,7 +424,7 @@
 .end method
 
 .method public onSensorChanged(Landroid/hardware/SensorEvent;)V
-    .locals 3
+    .locals 4
     .param p1, "event"    # Landroid/hardware/SensorEvent;
 
     .line 98
@@ -430,6 +448,10 @@
 
     move-result-object v0
 
+    const-string v3, "DozeScreenBrightness"
+
+    invoke-static {v3, v0}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I
+
     invoke-static {v0}, Landroid/os/Trace;->beginSection(Ljava/lang/String;)V
 
     .line 100
@@ -449,6 +471,10 @@
 
     .line 102
     invoke-direct {p0}, Lcom/android/systemui/doze/DozeScreenBrightness;->updateBrightnessAndReady()V
+
+    const v0, 0x0
+
+    invoke-direct {p0, v0}, Lcom/android/systemui/doze/DozeScreenBrightness;->setLightSensorEnabled(Z)V
     :try_end_0
     .catchall {:try_start_0 .. :try_end_0} :catchall_0
 
diff --git a/OPSystemUI/smali/com/android/systemui/statusbar/phone/StatusBar$DozeServiceHost.smali b/OPSystemUI/smali/com/android/systemui/statusbar/phone/StatusBar$DozeServiceHost.smali
index f80b72f..00ef027 100644
--- a/OPSystemUI/smali/com/android/systemui/statusbar/phone/StatusBar$DozeServiceHost.smali
+++ b/OPSystemUI/smali/com/android/systemui/statusbar/phone/StatusBar$DozeServiceHost.smali
@@ -769,6 +769,21 @@
     return-void
 .end method
 
+.method public setForceDozeBrightness(Z)V
+    .locals 1
+    .param p1, "force"    # I
+
+    .line 5823
+    iget-object v0, p0, Lcom/android/systemui/statusbar/phone/StatusBar$DozeServiceHost;->this$0:Lcom/android/systemui/statusbar/phone/StatusBar;
+
+    iget-object v0, v0, Lcom/android/systemui/statusbar/phone/StatusBar;->mStatusBarWindowManager:Lcom/android/systemui/statusbar/phone/StatusBarWindowManager;
+
+    invoke-virtual {v0, p1}, Lcom/android/systemui/statusbar/phone/StatusBarWindowManager;->setForceDozeBrightness(Z)V
+
+    .line 5824
+    return-void
+.end method
+
 .method public shouldAnimateScreenOff()Z
     .locals 1
 
@@ -818,7 +833,11 @@
 
     invoke-static {v0}, Lcom/android/systemui/statusbar/phone/StatusBar;->access$2100(Lcom/android/systemui/statusbar/phone/StatusBar;)Z
 
-    .line 5951
+    const v0, 0x1
+
+    invoke-virtual {p0, v0}, Lcom/android/systemui/statusbar/phone/StatusBar$DozeServiceHost;->setForceDozeBrightness(Z)V
+
+    .line 5695
     :cond_0
     return-void
 .end method
@@ -865,7 +884,11 @@
 
     invoke-static {v0}, Lcom/android/systemui/statusbar/phone/StatusBar;->access$2600(Lcom/android/systemui/statusbar/phone/StatusBar;)V
 
-    .line 5994
+    const v0, 0x0
+
+    invoke-virtual {p0, v0}, Lcom/android/systemui/statusbar/phone/StatusBar$DozeServiceHost;->setForceDozeBrightness(Z)V
+
+    .line 5738
     :cond_0
     return-void
 .end method
-- 
2.17.1

